version: '3.9'

services:
  zebra:
    # Using official Zebra image from Zcash Foundation
    # Pin to specific version for stability (update during M5 maintenance)
    image: zfnd/zebra:1.9.0
    container_name: zecdev-zebra
    
    networks:
      - zecdev
    
    # Port mappings (localhost only for security)
    ports:
      - "127.0.0.1:8232:8232"  # RPC
      - "127.0.0.1:8233:8233"  # P2P
    
    # Mount configuration and persistent state
    volumes:
      - zebra-data:/var/zebra/state
      - ../configs/zebra.toml:/etc/zebrad/zebrad.toml:ro
    
    # Environment variables
    environment:
      - NETWORK=Regtest
      - RUST_LOG=info,zebrad=debug
      - RUST_BACKTRACE=1
    
    # Health check to ensure Zebra is ready
    healthcheck:
      test: |
        curl -sf --max-time 5 \
          --data-binary '{"jsonrpc":"2.0","id":"healthcheck","method":"getinfo","params":[]}' \
          -H 'content-type: application/json' \
          http://localhost:8232/ > /dev/null || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    # Restart policy
    restart: unless-stopped
    
    # Resource limits (adjust based on your system)
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G

# Networks and volumes are defined in main docker-compose.yml