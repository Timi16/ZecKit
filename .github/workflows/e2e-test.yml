name: E2E Tests

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      fresh_start:
        description: 'Force fresh start (wipe all data)'
        required: false
        type: boolean
        default: false

jobs:
  e2e-tests:
    name: ZecKit E2E Test Suite
    runs-on: self-hosted
    
    timeout-minutes: 180
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Start Docker Desktop
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Ensuring Docker Desktop is Running"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          if ! docker ps > /dev/null 2>&1; then
            echo "Starting Docker Desktop..."
            open /Applications/Docker.app
            
            for i in {1..60}; do
              if docker ps > /dev/null 2>&1; then
                echo "✓ Docker daemon is ready!"
                break
              fi
              echo "Attempt $i/60: Waiting for Docker..."
              sleep 2
            done
          else
            echo "✓ Docker already running"
          fi
          
          docker --version
          docker compose version
          echo ""
      
      - name: Check for fresh start requirement
        id: fresh_check
        run: |
          FRESH_START="false"
          
          # Force fresh if manually triggered with fresh_start=true
          if [ "${{ github.event.inputs.fresh_start }}" == "true" ]; then
            echo "Manual fresh start requested"
            FRESH_START="true"
          fi
          
          # Force fresh if this is the first run (no existing volumes)
          if ! docker volume ls | grep -q "zeckit"; then
            echo "No existing volumes found - first run"
            FRESH_START="true"
          fi
          
          # Check if CLI binary exists and is recent
          if [ ! -f "cli/target/release/zecdev" ]; then
            echo "CLI binary not found - will rebuild"
            FRESH_START="true"
          fi
          
          echo "fresh_start=$FRESH_START" >> $GITHUB_OUTPUT
          echo ""
      
      - name: Quick cleanup (if not fresh)
        if: steps.fresh_check.outputs.fresh_start != 'true'
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Quick Cleanup (Reusing Data)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          docker compose down --remove-orphans 2>/dev/null || true
          
          echo "✓ Containers stopped, volumes preserved"
          echo ""
      
      - name: Deep cleanup (fresh start only)
        if: steps.fresh_check.outputs.fresh_start == 'true'
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Deep Cleanup (Fresh Start)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          docker compose down -v --remove-orphans 2>/dev/null || true
          docker system prune -f --volumes 2>/dev/null || true
          rm -rf /var/zaino /var/zingo /var/faucet_wallet 2>/dev/null || true
          
          echo "✓ Full cleanup complete"
          echo ""
      
      - name: Build/Update CLI binary
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Building ZecDev CLI"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          cd cli
          
          if [ "${{ steps.fresh_check.outputs.fresh_start }}" == "true" ] || \
             [ ! -f "target/release/zecdev" ] || \
             [ "src/main.rs" -nt "target/release/zecdev" ]; then
            echo "Rebuilding CLI binary..."
            cargo build --release
          else
            echo "Using existing CLI binary (no changes detected)"
          fi
          
          cd ..
          ls -lh cli/target/release/zecdev
          echo ""
      
      - name: Start devnet (quick start)
        if: steps.fresh_check.outputs.fresh_start != 'true'
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Starting ZecKit Devnet (Quick Start)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          # macOS-compatible timeout using background process
          ./cli/target/release/zecdev up --backend zaino &
          PID=$!
          
          # Wait up to 3 minutes
          SECONDS=0
          while kill -0 $PID 2>/dev/null && [ $SECONDS -lt 180 ]; do
            sleep 1
          done
          
          if kill -0 $PID 2>/dev/null; then
            echo "✗ Quick start timed out after 3 minutes"
            kill $PID 2>/dev/null || true
            echo "Falling back to fresh start..."
            docker compose down -v
            
            ./cli/target/release/zecdev up --backend zaino --fresh &
            PID=$!
            SECONDS=0
            while kill -0 $PID 2>/dev/null && [ $SECONDS -lt 600 ]; do
              sleep 1
            done
            
            if kill -0 $PID 2>/dev/null; then
              echo "✗ Fresh start also timed out"
              kill $PID 2>/dev/null || true
              exit 1
            fi
          fi
          
          wait $PID
          if [ $? -ne 0 ]; then
            echo "✗ Devnet startup failed!"
            docker compose logs || true
            exit 1
          fi
          
          echo ""
          echo "✓ Devnet started (using existing data)"
          echo ""
      
      - name: Start devnet (fresh start)
        if: steps.fresh_check.outputs.fresh_start == 'true'
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Starting ZecKit Devnet (Fresh Start)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          # macOS-compatible timeout
          ./cli/target/release/zecdev up --backend zaino --fresh &
          PID=$!
          
          # Wait up to 10 minutes for fresh start
          SECONDS=0
          while kill -0 $PID 2>/dev/null && [ $SECONDS -lt 600 ]; do
            sleep 1
          done
          
          if kill -0 $PID 2>/dev/null; then
            echo "✗ Devnet startup timed out after 10 minutes"
            kill $PID 2>/dev/null || true
            docker compose logs || true
            exit 1
          fi
          
          wait $PID
          if [ $? -ne 0 ]; then
            echo "✗ Devnet startup failed!"
            docker compose logs || true
            exit 1
          fi
          
          echo ""
          echo "✓ Devnet started from scratch"
          echo ""
      
      - name: Verify services are healthy
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Verifying Services"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          # Check Zebra RPC
          echo "Checking Zebra RPC..."
          for i in {1..30}; do
            if curl -sf --max-time 5 \
              --data-binary '{"jsonrpc":"2.0","id":"1","method":"getblockcount","params":[]}' \
              -H 'content-type: application/json' \
              http://127.0.0.1:8232 | grep -q "result"; then
              echo "✓ Zebra RPC OK"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "✗ Zebra RPC FAILED"
              exit 1
            fi
            sleep 2
          done
          
          # Check Zaino gRPC
          echo "Checking Zaino..."
          if docker exec zeckit-zaino zindexer --version > /dev/null 2>&1; then
            echo "✓ Zaino OK"
          else
            echo "✗ Zaino FAILED"
            exit 1
          fi
          
          # Check Faucet
          echo "Checking Faucet..."
          for i in {1..15}; do
            if curl -sf http://127.0.0.1:8080/health | grep -q "OK"; then
              echo "✓ Faucet OK"
              break
            fi
            if [ $i -eq 15 ]; then
              echo "✗ Faucet FAILED"
              exit 1
            fi
            sleep 2
          done
          
          # Check Zingo Wallet
          echo "Checking Zingo Wallet..."
          if docker exec zeckit-zingo-wallet bash -c "echo -e 'quit' | zingo-cli --data-dir /var/zingo --server http://zaino:9067 --chain regtest --nosync" > /dev/null 2>&1; then
            echo "✓ Zingo Wallet OK"
          else
            echo "✗ Zingo Wallet FAILED"
            exit 1
          fi
          
          echo ""
          echo "✓ All services healthy!"
          echo ""
      
      - name: Run smoke tests
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Running Smoke Tests"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          ./cli/target/release/zecdev test
          
          TEST_EXIT_CODE=$?
          
          echo ""
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "✓ All smoke tests PASSED!"
          else
            echo "✗ Smoke tests FAILED!"
            exit 1
          fi
          echo ""
      
      - name: Check wallet balance
        if: always()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Wallet Status"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          docker exec zeckit-zingo-wallet bash -c "echo -e 'balance\nquit' | zingo-cli --data-dir /var/zingo --server http://zaino:9067 --chain regtest --nosync" 2>/dev/null || echo "Could not retrieve balance"
          echo ""
      
      - name: Collect logs
        if: failure()
        run: |
          echo "Collecting logs for artifact..."
          mkdir -p logs
          
          docker compose logs zebra > logs/zebra.log 2>&1 || true
          docker compose logs zaino > logs/zaino.log 2>&1 || true
          docker compose logs zingo-wallet-zaino > logs/zingo-wallet.log 2>&1 || true
          docker compose logs faucet-zaino > logs/faucet.log 2>&1 || true
          docker ps -a > logs/containers.log 2>&1 || true
          
          echo "✓ Logs collected"
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-logs-${{ github.run_number }}
          path: logs/
          retention-days: 7
      
      - name: Cleanup
        if: always()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Cleanup"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          # Stop containers but KEEP volumes for next run
          docker compose down --remove-orphans 2>/dev/null || true
          
          echo "✓ Containers stopped (volumes preserved for next run)"
          echo ""
      
      - name: Test summary
        if: always()
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  E2E Test Execution Summary"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "✓ Status: ALL TESTS PASSED ✓"
            echo ""
            echo "Run type: ${{ steps.fresh_check.outputs.fresh_start == 'true' && 'Fresh Start' || 'Quick Start (Reused Data)' }}"
            echo ""
            echo "Next run will be faster (reusing volumes)!"
          else
            echo "✗ Status: TESTS FAILED ✗"
            echo ""
            echo "Logs available in artifact: e2e-test-logs-${{ github.run_number }}"
          fi
          
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
